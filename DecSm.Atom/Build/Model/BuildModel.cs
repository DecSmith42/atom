namespace DecSm.Atom.Build.Model;

/// <summary>
///     Represents the complete model of a build, including all targets and their states.
/// </summary>
/// <remarks>
///     This model is generated by Atom on startup and serves as the primary source of information for the build.
///     It is immutable by design, with the exception of the values in <see cref="TargetStates" />.
/// </remarks>
[PublicAPI]
public sealed record BuildModel
{
    /// <summary>
    ///     Gets a read-only list of all targets defined in the build, regardless of their execution status.
    /// </summary>
    public required IReadOnlyList<TargetModel> Targets { get; init; }

    /// <summary>
    ///     Gets a read-only dictionary mapping each target to its current state.
    /// </summary>
    /// <seealso cref="TargetState" />
    public required IReadOnlyDictionary<TargetModel, TargetState> TargetStates { get; init; }

    /// <summary>
    ///     Gets the assembly in which the build was defined.
    /// </summary>
    public required Assembly DeclaringAssembly { get; init; }

    /// <summary>
    ///     Gets the target that is currently running.
    /// </summary>
    /// <returns>The currently running <see cref="TargetModel" />, or <c>null</c> if no target is running.</returns>
    public TargetModel? CurrentTarget =>
        Targets.FirstOrDefault(targetModel => TargetStates[targetModel] is { Status: TargetRunState.Running });

    /// <summary>
    ///     Gets a target by its name.
    /// </summary>
    /// <param name="name">The name of the target to retrieve.</param>
    /// <returns>The <see cref="TargetModel" /> with the specified name.</returns>
    /// <exception cref="ArgumentException">Thrown if no target with the specified name is found.</exception>
    public TargetModel GetTarget(string name) =>
        Targets.FirstOrDefault(t => t.Name == name) ?? throw new ArgumentException($"Target '{name}' not found.");
}
